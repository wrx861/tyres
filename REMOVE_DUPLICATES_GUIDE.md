# Инструкция по удалению дубликатов пользователей

## Шаг 1: Скопировать скрипт на сервер

```bash
# Копируем скрипт
sudo cp /app/remove_duplicate_users.py /opt/tyres-app/remove_duplicate_users.py
sudo chmod +x /opt/tyres-app/remove_duplicate_users.py
```

## Шаг 2: Проверить что будет удалено (пробный запуск)

```bash
cd /opt/tyres-app
sudo /opt/tyres-app/backend/venv/bin/python3 remove_duplicate_users.py
```

Скрипт покажет:
- ✅ Какие записи будут ОСТАВЛЕНЫ (самые ранние)
- ❌ Какие записи будут УДАЛЕНЫ (дубликаты)
- Общее количество дубликатов

**НА ЭТОМ ЭТАПЕ НИЧЕГО НЕ УДАЛЯЕТСЯ!** Это только предварительный просмотр.

## Шаг 3: Удалить дубликаты (реальное удаление)

Если всё выглядит правильно, запустите с параметром `--confirm`:

```bash
cd /opt/tyres-app
sudo /opt/tyres-app/backend/venv/bin/python3 remove_duplicate_users.py --confirm
```

Скрипт спросит подтверждение:
```
Вы уверены что хотите удалить дубликаты? (yes/no):
```

Введите `yes` для подтверждения.

## Логика работы скрипта

Для каждого `telegram_id` с дубликатами:
1. Находит все записи
2. Сортирует по дате создания (`created_at`)
3. **ОСТАВЛЯЕТ** самую раннюю запись
4. **УДАЛЯЕТ** все остальные дубликаты

## Примеры

### Если дубликатов нет:
```
✅ Дубликатов не найдено! База данных чистая.
```

### Если найдены дубликаты:
```
⚠️  Найдено 2 групп дубликатов:

================================================================================
Telegram ID: 123456789
Количество дубликатов: 2
--------------------------------------------------------------------------------
✅ ОСТАВЛЯЕМ (самая ранняя):
  Имя: Иван Иванов
  Username: @ivan
  Создан: 2024-11-07 10:30:00
  Админ: False

❌ УДАЛЯЕМ (1 дубликатов):
  1. Имя: Иван Иванов
     Username: @ivan
     Создан: 2024-11-07 10:30:02
```

## Проверка после удаления

После удаления скрипт автоматически проверяет:
```
✅ Проверка: дубликатов больше нет! ✨
```

## В случае проблем

Если что-то пошло не так, дубликаты можно найти вручную в MongoDB:

```bash
mongosh tires_shop --eval '
db.users.aggregate([
  {$group: {_id: "$telegram_id", count: {$sum: 1}}},
  {$match: {count: {$gt: 1}}}
]).forEach(printjson)
'
```

## Важно! ⚠️

- Скрипт НЕ удаляет пользователей, он удаляет только ДУБЛИКАТЫ
- Для каждого telegram_id остается ровно 1 запись (самая ранняя)
- После применения исправления (обновление кода) новые дубликаты создаваться не будут

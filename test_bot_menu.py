#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –º–µ–Ω—é Telegram –±–æ—Ç–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –∫–Ω–æ–ø–∫—É –®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂, –ü—Ä–∞–π—Å, –ó–∞–ø–∏—Å–∞—Ç—å—Å—è, –ù–∞–∑–∞–¥
"""

import asyncio
import os
import sys
from dotenv import load_dotenv
from telegram import Bot

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv('/app/backend/.env')

BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN')
ADMIN_ID = os.environ.get('ADMIN_TELEGRAM_ID')

async def test_bot_menu():
    """–¢–µ—Å—Ç –º–µ–Ω—é –±–æ—Ç–∞"""
    if not BOT_TOKEN:
        print("‚ùå TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return False
    
    if not ADMIN_ID:
        print("‚ùå ADMIN_TELEGRAM_ID –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return False
    
    try:
        bot = Bot(token=BOT_TOKEN)
        
        print("="*60)
        print("üß™ –¢–ï–°–¢ –ú–ï–ù–Æ TELEGRAM –ë–û–¢–ê")
        print("="*60)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ
        print("\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ")
        me = await bot.get_me()
        print(f"‚úÖ –ë–æ—Ç: @{me.username} (ID: {me.id})")
        print(f"   –ò–º—è: {me.first_name}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
        print(f"\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
        
        test_message = (
            "üß™ <b>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é –±–æ—Ç–∞</b>\n\n"
            "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:\n\n"
            "1Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /start\n"
            "   ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—Å—Ç: '–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –≤–∞—à –∞–¥—Ä–µ—Å'\n"
            "   ‚úÖ –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ 'üîß –®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂'\n\n"
            "2Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂'\n"
            "   ‚úÖ –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∏:\n"
            "      ‚Ä¢ üí∞ –ü—Ä–∞–π—Å\n"
            "      ‚Ä¢ üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è\n"
            "      ‚Ä¢ ‚¨ÖÔ∏è –ù–∞–∑–∞–¥\n\n"
            "3Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ '–ü—Ä–∞–π—Å'\n"
            "   ‚úÖ –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å—Å—è –ø—Ä–∞–π—Å-–ª–∏—Å—Ç\n"
            "   ‚úÖ –ö–Ω–æ–ø–∫–∏: –ó–∞–ø–∏—Å–∞—Ç—å—Å—è, –ù–∞–∑–∞–¥\n\n"
            "4Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è'\n"
            "   ‚úÖ –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ:\n"
            "      '–ú—ã –µ—â–µ –Ω–µ –Ω–∞—à–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤...'\n"
            "   ‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç –∞–¥–º–∏–Ω–∞: @malg1nov\n\n"
            "5Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ '–ù–∞–∑–∞–¥'\n"
            "   ‚úÖ –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –º–µ–Ω—é\n\n"
            "<i>–í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–ª—è—Ç—å –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (–±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö)</i>"
        )
        
        message = await bot.send_message(
            chat_id=ADMIN_ID,
            text=test_message,
            parse_mode='HTML'
        )
        print(f"‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã (message_id: {message.message_id})")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –õ–æ–≥–∏ backend
        print(f"\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ backend")
        import subprocess
        result = subprocess.run(
            ["tail", "-30", "/var/log/supervisor/backend.err.log"],
            capture_output=True,
            text=True
        )
        
        logs = result.stdout
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
        if "Telegram bot polling started successfully!" in logs:
            print("‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ polling —Ä–µ–∂–∏–º–µ")
        else:
            print("‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ polling")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ callback
        if "CallbackQueryHandler" in logs or "callback" in logs.lower():
            print("‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –∫–Ω–æ–ø–æ–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–¥–∞–≤–Ω—é—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫
        if "clicked button:" in logs:
            print("‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–µ–¥–∞–≤–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å –∫–Ω–æ–ø–∫–∞–º–∏")
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–ª–∏–∫–∏
            for line in logs.split('\n'):
                if "clicked button:" in line:
                    print(f"   üìå {line.split('INFO -')[-1].strip()}")
        
        print("\n" + "="*60)
        print("‚ú® –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –†–£–ß–ù–û–ì–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø")
        print("="*60)
        print(f"\n1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç: https://t.me/{me.username}")
        print("2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /start")
        print("3. –ù–∞–∂–∏–º–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –º–µ–Ω—é")
        print("\nüìä –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:")
        print("   ‚úÖ –¢–µ–∫—Å—Ç '–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –≤–∞—à –∞–¥—Ä–µ—Å' (–Ω–µ '–≤ –≤–∞—à –≥–æ—Ä–æ–¥')")
        print("   ‚úÖ –ö–Ω–æ–ø–∫–∞ '–®–∏–Ω–æ–º–æ–Ω—Ç–∞–∂' –ø–æ–¥ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º")
        print("   ‚úÖ –ú–µ–Ω—é —à–∏–Ω–æ–º–æ–Ω—Ç–∞–∂–∞ —Å 3 –∫–Ω–æ–ø–∫–∞–º–∏")
        print("   ‚úÖ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è")
        print("   ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞—Ö —Å @malg1nov")
        print("   ‚úÖ –ö–Ω–æ–ø–∫–∞ '–ù–∞–∑–∞–¥' –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –º–µ–Ω—é")
        print("   ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (–Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–æ–µ)")
        
        print("\nüìù –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:")
        print("   tail -f /var/log/supervisor/backend.err.log | grep -E '(clicked button|telegram)'")
        
        print("\n" + "="*60)
        print("‚úÖ –í–°–ï –ü–†–û–í–ï–†–ö–ò –ó–ê–í–ï–†–®–ï–ù–´")
        print("="*60)
        
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == '__main__':
    success = asyncio.run(test_bot_menu())
    sys.exit(0 if success else 1)

# ü§ñ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Telegram –±–æ—Ç–∞

## ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!

**–ë—ã–ª–æ:** –î–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø—ã—Ç–∞–ª–∏—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω —Ç–æ–∫–µ–Ω –±–æ—Ç–∞:
- `/opt/tyres-app/telegram_bot.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ (/start, /help)
- `backend/services/telegram_bot.py` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–°—Ç–∞–ª–æ:** –û–¥–∏–Ω –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–æ—Ç –≤ backend:
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ (/start, /help)
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∑–∞–∫–∞–∑—ã, –Ω–æ–≤—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ —Å FastAPI
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Ç–æ–∫–µ–Ω–æ–≤

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
FastAPI Backend (–ø–æ—Ä—Ç 8001)
  ‚îú‚îÄ‚îÄ API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (/api/...)
  ‚îî‚îÄ‚îÄ Telegram Bot (polling)
      ‚îú‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
      ‚îÇ   ‚îú‚îÄ‚îÄ /start - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
      ‚îÇ   ‚îî‚îÄ‚îÄ /help - —Å–ø—Ä–∞–≤–∫–∞
      ‚îî‚îÄ‚îÄ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
          ‚îú‚îÄ‚îÄ –ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã ‚Üí –∞–¥–º–∏–Ω—É
          ‚îú‚îÄ‚îÄ –ù–æ–≤—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ ‚Üí –∞–¥–º–∏–Ω—É
          ‚îú‚îÄ‚îÄ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ‚Üí –∫–ª–∏–µ–Ω—Ç—É
          ‚îî‚îÄ‚îÄ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ‚Üí –∫–ª–∏–µ–Ω—Ç—É
```

## üìù –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### 1. `/app/backend/services/telegram_bot.py`
–î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã:
- `start_bot_polling()` - –∑–∞–ø—É—Å–∫ polling —Ä–µ–∂–∏–º–∞
- `stop_bot_polling()` - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ polling
- `_handle_start()` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /start
- `_handle_help()` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /help

### 2. `/app/backend/server.py`
–î–æ–±–∞–≤–ª–µ–Ω—ã lifecycle hooks:
- `@app.on_event("startup")` - –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ FastAPI
- `@app.on_event("shutdown")` - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏

### 3. –£–¥–∞–ª–µ–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
- ‚ùå –ë–æ–ª—å—à–µ –ù–ï –Ω—É–∂–µ–Ω supervisor –ø—Ä–æ—Ü–µ—Å—Å `tyres-telegram-bot`
- ‚ùå –ë–æ–ª—å—à–µ –ù–ï –Ω—É–∂–µ–Ω —Ñ–∞–π–ª `/opt/tyres-app/telegram_bot.py`

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç
```bash
cd /app
python3 test_telegram_bot.py
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç –≤ Telegram: [@shoptyresbot](https://t.me/shoptyresbot)
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start` - –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
3. –ê–¥–º–∏–Ω –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/help` - –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–π—Ç–∏ —Å–ø—Ä–∞–≤–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
sudo tail -f /var/log/supervisor/backend.err.log | grep telegram

# –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å:
# - "Telegram bot polling started successfully!"
# - "HTTP Request: POST ...getUpdates" (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫)
```

## üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend (–±–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
sudo supervisorctl restart backend

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sudo supervisorctl status backend
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
```bash
# –°—Ç–∞—Ç—É—Å backend
sudo supervisorctl status backend

# –õ–æ–≥–∏ backend (–≤–∫–ª—é—á–∞—è –±–æ—Ç–∞)
sudo tail -50 /var/log/supervisor/backend.err.log

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
sudo grep -i error /var/log/supervisor/backend.err.log
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ polling
```bash
# –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ getUpdates –∑–∞–ø—Ä–æ—Å—ã
tail -f /var/log/supervisor/backend.err.log | grep getUpdates
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥
```bash
# –û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –±–æ—Ç—É, –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
tail -f /var/log/supervisor/backend.err.log | grep "User.*started the bot"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```bash
# –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
tail -f /var/log/supervisor/backend.err.log | grep "Message sent"
```

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

1. **–û–¥–∏–Ω —Ç–æ–∫–µ–Ω, –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å**
   - –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Ç–æ–∫–µ–Ω–æ–≤
   - –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞

2. **–£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**
   - –û–¥–∏–Ω supervisor –ø—Ä–æ—Ü–µ—Å—Å (backend)
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞

3. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –í—Å–µ –ª–æ–≥–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
   - –õ–µ–≥—á–µ –æ—Ç–ª–∞–¥–∫–∞

4. **–õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - –ú–µ–Ω—å—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
   - –ú–µ–Ω—å—à–µ —Å–µ—Ç–µ–≤—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

- **–ù–ï –∑–∞–ø—É—Å–∫–∞–π—Ç–µ** –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å `telegram_bot.py` - —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Ç–æ–∫–µ–Ω–æ–≤
- **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ** webhook –∏ polling –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ **—É–¥–∞–ª—è–µ—Ç webhook** –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (–ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –≤ polling —Ä–µ–∂–∏–º)

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏

–ï—Å–ª–∏ —É –≤–∞—Å –±—ã–ª–∞ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º:

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ (–µ—Å–ª–∏ –æ–Ω –±—ã–ª)
sudo supervisorctl stop tyres-telegram-bot

# 2. –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é supervisor (–µ—Å–ª–∏ –µ—Å—Ç—å)
sudo rm -f /etc/supervisor/conf.d/tyres-telegram-bot.conf

# 3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å supervisor
sudo supervisorctl reread
sudo supervisorctl update

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend (—Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –±–æ—Ç–æ–º)
sudo supervisorctl restart backend

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
sudo supervisorctl status
tail -20 /var/log/supervisor/backend.err.log
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `TELEGRAM_BOT_TOKEN` –∑–∞–¥–∞–Ω –≤ `.env`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö —Ç–æ–∫–µ–Ω
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend

---

‚ú® **–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –æ–¥–∏–Ω –º–æ—â–Ω—ã–π –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–æ—Ç!**
